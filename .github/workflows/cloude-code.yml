name: Cloude Code

# Triggered by repository_dispatch from Howler Edge Function
on:
  repository_dispatch:
    types: [cloude-code-task]

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  process:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Claude Code may take a while

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better context

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Run Claude Code
        id: claude
        env:
          # Priority: OAuth token (MAX subscription), fallback to API key
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Create prompt file
          cat > /tmp/prompt.txt << 'PROMPT_EOF'
          ${{ github.event.client_payload.context }}

          ---
          CURRENT REQUEST:
          ${{ github.event.client_payload.message }}

          ---
          INSTRUCTIONS:
          - Review the request and make the necessary changes
          - Commit your changes with a descriptive message
          - Provide a summary of what you did
          PROMPT_EOF

          # Run Claude Code and capture output
          # --dangerously-skip-permissions allows creating new files (safe since changes go through PR review)
          claude --print --model claude-opus-4-20250514 --dangerously-skip-permissions "$(cat /tmp/prompt.txt)" 2>&1 | tee /tmp/claude_output.txt

          # Save summary for PR body
          echo "summary<<EOF" >> $GITHUB_OUTPUT
          tail -50 /tmp/claude_output.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Get branch and commit info
        id: info
        if: success()
        run: |
          echo "branch=$(git branch --show-current)" >> $GITHUB_OUTPUT
          echo "commit=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Generate PR title and branch name
        id: meta
        run: |
          MSG="${{ github.event.client_payload.message }}"
          EXISTING_BRANCH="${{ github.event.client_payload.existing_branch }}"
          EXISTING_PR="${{ github.event.client_payload.existing_pr_number }}"

          # Truncate for PR title (50 chars)
          TRUNCATED="${MSG:0:50}"
          if [ ${#MSG} -gt 50 ]; then
            TRUNCATED="${TRUNCATED}..."
          fi
          echo "title=${TRUNCATED}" >> $GITHUB_OUTPUT

          # Use existing branch if continuing, otherwise create new
          if [ -n "$EXISTING_BRANCH" ]; then
            echo "branch=${EXISTING_BRANCH}" >> $GITHUB_OUTPUT
            echo "is_continuation=true" >> $GITHUB_OUTPUT
            echo "existing_pr=${EXISTING_PR}" >> $GITHUB_OUTPUT
          else
            # Slugify for branch name (lowercase, replace non-alphanumeric with dashes)
            SLUG=$(echo "$MSG" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | cut -c1-40 | sed 's/^-//;s/-$//')
            echo "branch=cloude-code/${SLUG}-${{ github.run_id }}" >> $GITHUB_OUTPUT
            echo "is_continuation=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout existing branch (if continuing)
        if: steps.meta.outputs.is_continuation == 'true'
        run: |
          git fetch origin ${{ steps.meta.outputs.branch }} || true
          git checkout ${{ steps.meta.outputs.branch }} || git checkout -b ${{ steps.meta.outputs.branch }}

      - name: Create Pull Request
        id: create-pr
        if: success() && steps.meta.outputs.is_continuation != 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "[Cloude Code] ${{ steps.meta.outputs.title }}"
          branch: ${{ steps.meta.outputs.branch }}
          delete-branch: true
          title: "[Cloude Code] ${{ steps.meta.outputs.title }}"
          body: |
            ## Cloude Code PR

            **Request:** ${{ github.event.client_payload.message }}

            **Summary:** ${{ steps.claude.outputs.summary }}

            ---

            *This PR was created automatically by Cloude Code via Howler.*

            **Thread ID:** \`${{ github.event.client_payload.thread_id }}\`

      - name: Push to existing PR branch (if continuing)
        id: push-existing
        if: success() && steps.meta.outputs.is_continuation == 'true'
        run: |
          git add -A
          git commit -m "[Cloude Code] ${{ steps.meta.outputs.title }}" || echo "No changes to commit"
          git push origin ${{ steps.meta.outputs.branch }}
          echo "Updated existing PR #${{ steps.meta.outputs.existing_pr }}"

      - name: Notify Howler - Success
        if: success() && (steps.create-pr.outputs.pull-request-url || steps.meta.outputs.is_continuation == 'true')
        env:
          WEBHOOK_URL: ${{ github.event.client_payload.webhook_url }}
          WEBHOOK_SECRET: ${{ secrets.HOWLER_AGENT_WEBHOOK_SECRET }}
          THREAD_ID: ${{ github.event.client_payload.thread_id }}
          CLAUDE_SUMMARY: ${{ steps.claude.outputs.summary }}
          BRANCH: ${{ steps.meta.outputs.branch }}
          IS_CONTINUATION: ${{ steps.meta.outputs.is_continuation }}
          EXISTING_PR: ${{ steps.meta.outputs.existing_pr }}
          NEW_PR_URL: ${{ steps.create-pr.outputs.pull-request-url }}
          NEW_PR_NUMBER: ${{ steps.create-pr.outputs.pull-request-number }}
          REPO: ${{ github.repository }}
        run: |
          # Determine PR URL and number (new or existing)
          if [ "$IS_CONTINUATION" == "true" ]; then
            PR_URL="https://github.com/${REPO}/pull/${EXISTING_PR}"
            PR_NUMBER="$EXISTING_PR"
          else
            PR_URL="$NEW_PR_URL"
            PR_NUMBER="$NEW_PR_NUMBER"
          fi

          # Build JSON payload using jq to handle escaping properly
          # Using env vars avoids shell expansion issues with special characters
          PAYLOAD=$(jq -n \
            --arg thread_id "$THREAD_ID" \
            --arg pr_url "$PR_URL" \
            --arg pr_number "$PR_NUMBER" \
            --arg branch "$BRANCH" \
            --arg summary "$CLAUDE_SUMMARY" \
            --arg repo "$REPO" \
            --arg is_continuation "$IS_CONTINUATION" \
            '{
              thread_id: $thread_id,
              pr_url: $pr_url,
              pr_number: $pr_number,
              branch: $branch,
              status: "success",
              summary: $summary,
              repo: $repo,
              is_continuation: $is_continuation
            }')

          # Compute HMAC-SHA256 signature
          SIGNATURE=$(echo -n "$PAYLOAD" | openssl dgst -sha256 -hmac "$WEBHOOK_SECRET" | cut -d' ' -f2)

          curl -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -H "X-Hub-Signature-256: sha256=$SIGNATURE" \
            -d "$PAYLOAD"

          echo "Notified Howler of PR: ${PR_URL}"

      - name: Notify Howler - Failure
        if: failure()
        env:
          WEBHOOK_URL: ${{ github.event.client_payload.webhook_url }}
          WEBHOOK_SECRET: ${{ secrets.HOWLER_AGENT_WEBHOOK_SECRET }}
          THREAD_ID: ${{ github.event.client_payload.thread_id }}
          REPO: ${{ github.repository }}
        run: |
          # Build JSON payload using jq
          PAYLOAD=$(jq -n \
            --arg thread_id "$THREAD_ID" \
            --arg repo "$REPO" \
            '{
              thread_id: $thread_id,
              pr_url: "",
              status: "failure",
              summary: "GitHub Action failed. Check workflow logs for details.",
              repo: $repo
            }')

          SIGNATURE=$(echo -n "$PAYLOAD" | openssl dgst -sha256 -hmac "$WEBHOOK_SECRET" | cut -d' ' -f2)

          curl -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -H "X-Hub-Signature-256: sha256=$SIGNATURE" \
            -d "$PAYLOAD" || true

          echo "Notified Howler of failure"
